#!/usr/bin/env bash
echo loading ~/.bash/bashrc

# Identify env with uname, make it lower case, only take first part before _
# ENV_NAME is used to call appropriate bash options for the environment. (ie darwin, cygwin, etc...)
# uname -o option doesn't work on Darwin (sed required for cygwin to remove _ and trailing text)
echo finding env_name
date -u "+%Y-%m-%dT%H:%M:%SZ"
export ENV_NAME=$(uname -s | tr '[:upper:]' '[:lower:]' | sed -e 's/_.*//')
date -u "+%Y-%m-%dT%H:%M:%SZ"

#Load Env specific bash stuff first
#  This is particularly important for cygwin because settings like
#  `export CYGWIN="..."` needs to be set before some stuff like nodejs commands
#  will give an error message

echo sourcing bash_${ENV_NAME}
date -u "+%Y-%m-%dT%H:%M:%SZ"
[ -r ~/.bash/bash_${ENV_NAME} ] && . ~/.bash/bash_${ENV_NAME}
echo sourcing bash_common
date -u "+%Y-%m-%dT%H:%M:%SZ"
[ -r ~/.bash/bash_common ] && . ~/.bash/bash_common
echo sourcing bash_prompt
date -u "+%Y-%m-%dT%H:%M:%SZ"
[ -r ~/.bash/bash_prompt ] && . ~/.bash/bash_prompt

echo adding paths
date -u "+%Y-%m-%dT%H:%M:%SZ"
# Move (or Add) /usr/local/bin to the front of the path
[ -d /usr/local/bin ] && export PATH=$(echo "/usr/local/bin:$PATH" | sed -e 's;:/usr/local/bin;;')
date -u "+%Y-%m-%dT%H:%M:%SZ"

# Move (or Add) npm's bin folder to the front of the path
# Often $NPMPREFIXBIN=/usr/local/bin, so I add this before $HOME/.local/bin
if [[ ${ENV_NAME} != "cygwin" ]] && [[ ${ENV_NAME} != "mingw32" ]]; then
  [ `which npm 2> /dev/null` ] && NPMPREFIXBIN=`npm config get prefix`/bin
  [ -d $NPMPREFIXBIN ] && export PATH=$(echo "$NPMPREFIXBIN:$PATH" | sed -e "s;:$NPMPREFIXBIN;;")
  unset NPMPREFIXBIN
fi

date -u "+%Y-%m-%dT%H:%M:%SZ"
# Move (or Add) /usr/local/bin to the front of the path
[ -d $HOME/.local/bin ] && export PATH=$(echo "$HOME/.local/bin:$PATH")

date -u "+%Y-%m-%dT%H:%M:%SZ"

# Load RVM into a shell session *as a function*
# Loading RVM also adss $HOME/.rvm/bin to $PATH
if [ -r "$HOME/.rvm/scripts/rvm" ]; then
  echo sourcing rvm
  date -u "+%Y-%m-%dT%H:%M:%SZ"
  source "$HOME/.rvm/scripts/rvm"
else
  if [ -r /usr/local/rvm/scripts/rvm ]; then
    echo sourcing rvm
    date -u "+%Y-%m-%dT%H:%M:%SZ"
    source /usr/local/rvm/scripts/rvm
  fi
fi

date -u "+%Y-%m-%dT%H:%M:%SZ"


# if there is a bin folder in home, add it to front of  PATH
[ -d $HOME/bin ] && export PATH=$HOME/bin:$PATH
date -u "+%Y-%m-%dT%H:%M:%SZ"

#Source/evaluate bash completion scripts
#must be done after putting npm, grunt, and bower in $PATH
if [[ ${ENV_NAME} != "cygwin" ]] && [[ ${ENV_NAME} != "mingw32" ]]; then
  [ `which npm   2> /dev/null` ] && [ -r $HOME/.bash/completion/npm_completion ]   && . $HOME/.bash/completion/npm_completion
  [ `which grunt 2> /dev/null` ] && [ -r $HOME/.bash/completion/grunt_completion ] && . $HOME/.bash/completion/grunt_completion
  [ `which bower 2> /dev/null` ] && [ -r $HOME/.bash/completion/bower_completion ] && . $HOME/.bash/completion/bower_completion
fi
date -u "+%Y-%m-%dT%H:%M:%SZ"
